# 广东定制

## 文件状态查询

- 查询根据业务系统`id`查询`file_upload_record`表
	- 如果不存在，上传文件，返回`1文件初始化中`
		- 文件上传成功，创建初始化Job，返回`1文件初始化中`
		- 文件上传失败，返回`3文件初始化失败`
	- 如果存在，继续后续判断。
- 根据OpenCloud服务获取文件状态
	- 如果Job的状态为`waiting`或`inprogress`,返回`1文件初始化中`
	- 如果`geometry`或`uasignproperties`Job的状态为`failed`,返回`3文件初始化失败`，此时文件无法打开查看。（这里不对签章或文件回传的Job状态进行判断，而是在后续步骤进行判断）
	- 如果未出现以上情况，暂且将状态设置为`2文件初始化完成`,继续后续判断。
- 查看`file_sign_record`表，获取签章记录。
	- 如果签章记录不为空，根据签章记录中的JobId查询Job状态
		- 如果状态为`waiting`或`inprogress`,设置状态为`4签名中`。
			- 如果状态为`inprogress`，并且当前记录中不存在签名结果，查询待签名数据，并将待签名数据存储在记录中。
			- 如果状态为`inprogress`，并且当前记录中存在签名结果，将签名结果更新到数据库中。
		- 如果状态为`failed`,设置状态为`5签名失败`。
		- 如果状态为`done`,判断文件回传状态。
			- 如果回传状态为`0未回传`,开始回传文件。（阻塞）
				- 如果回传成功，设置状态为`6文件签章成功`。
				- 如果回传失败，设置状态为`7文件回传失败`。
			- 如果回传状态为`1已回传`,设置状态为`6文件签章成功`。
			- 如果回传状态为`2回传失败`,设置状态为`7文件回传失败`。
